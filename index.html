<!doctype html>
<html>
    <head>
        <title>The Studio</title>
        <meta name="description" content="">
        <link rel="stylesheet" href="vendor/css/vendor.css" />
        <link rel="stylesheet" href="dist/formbuilder.css" />
    </head>
    <body>
        <header><span class="logo"></span> <h1>The Studio | <small>cook & serve new, native, cross-platform apps, faster than it takes to make coffee!</small></h1></header>
        <article>
            <div class='fb-main'></div>
        </article>
        <footer>
            <table>
                <tr>
                    <td>
                        <p>  Read about 
                        <a target="_blank" href="https://nuscribes.com/scribes_app/book/40/read/#Studio">The Studio</a>,
                        <a target="_blank" href="https://nuscribes.com/scribes_app/book/40/read/#Historion">The Historion</a> and 
                        <a target="_blank" href="https://nuscribes.com/scribes_app/book/40/read/#Theatre">The Theatre</a>,
                        that are all part of the amazing, disruptive, emerging-future tech called
                        <a target="_blank" href="https://nuscribes.com/scribes_app/book/40/read/?#chapter-500">Project Okot (Project-O)</a> - yet another service to humanity, by the <a target="_blank" href="https://nuchwezi.com">NuChwezi</a>
                        </p>
                    </td>
                    <td>
                        <a target="_blank" href="https://nuchwezi.com">
                            <span class="logo-nuchwezi"></span>
                        </a>
                    </td>
                </tr>
            </table>
        </footer>

        <script src="vendor/js/vendor.js"></script>
        <script src="vendor/js/qrcode.js"></script>
        <script src="vendor/js/jquery.qrcode.js"></script>
        <script src="vendor/js/FileSaver.js"></script>
        <script src="vendor/js/Blob.js"></script>
        <script src="vendor/js/jscolor.min.js"></script>
        <script src="dist/formbuilder.js"></script>

        <script>
            var defaultQRCODE_SIZE = 200;
            var defaultQRCODE_EXPORT_SIZE = 500;
            var defaultEXPORT_SIZE_H = 400;
            var defaultEXPORT_SIZE_W = 1000;

            function make_qrcode(selector,data,size){
                $(selector).empty();
                $(selector).qrcode({
                    render: 'canvas',
                    width: size,
                    height: size,
                    text: data
                });
            }

            function init_fb(persona){

                fb = null;

                if(persona) {
                    fb = new Formbuilder({
                        selector: '.fb-main',
                        bootstrapData: persona.fields
                    });
                    $('#app-name').val(persona.app.name);
                    $('#app-color').val(persona.app.color);
                    $('#publish-channel').val(persona.app.channel);
                    $('#app-brand-image').val(persona.app.brand_image);
                    $('#theatre-uri').val(persona.app.theatre_address);
                    $('#transport-mode').val(persona.app.transport_mode);
                    $('#app-description').val(persona.app.description);
                    if(persona.app.uuid)
                        window.app_uuid = persona.app.uuid;
                    else
                        window.app_uuid = undefined;
                }
                else {
                    fb = new Formbuilder({
                        selector: '.fb-main',
                    });
                }

                if(fb == null)
                    return;

                fb.on('save', function(payload){
                    console.log(payload);

                    if(window.publish_persona){

                      $('#code').html('<span class="publish-status">Wait as this persona is published...</span>');
                        $.ajax({
                          url: 'https://theatre.nuchwezi.com/api/persona/create/',
                          type: 'POST',
                          data: payload,
                          contentType: "application/json",
                          success: function(data){
                                console.log(data)
                                make_qrcode('#code',data, defaultQRCODE_EXPORT_SIZE);
                          },
                          error: function(){
                              $('#code').html('<span class="publish-failed">Publishing of this persona failed. Ensure that this studio has access to persona publishing facility, such as a theatre. Contact tech[at]nuchwezi[dot]com, for access to a reliable, first-class theatre implementation, or get access to the entire suite of technologies in Project-Okot.</span>');
                          }
                        });

                        window.publish_persona = false;
                    }

                    if(window.download_persona){
                        var appName = JSON.parse(payload).app.name.replace(/\s+/g,"_") || "Persona";
                        var persona_file_name = appName + "-" + (new Date()).toISOString() + ".persona";
                        $('#code').html('<span class="publish-status">Please save the generated Persona file: ' + persona_file_name + '</span>');
                        saveAs(new Blob([payload], { type: "application/json+persona" }), persona_file_name)
                        window.download_persona = false;
                    }
                })

                $('#import-persona-file').on('change',function(evt){
                       var files = evt.target.files;
                       var file = files[0];           
                       var reader = new FileReader();
                       reader.onload = function() {
                         console.log(this.result);            
                         try{
                             init_fb(JSON.parse(this.result));
                              $('#code').html('<span class="publish-status">A new persona has been imported. You can now proceed with modifying it...</span>');
                        }catch(e){
                            $('#code').html('<span class="publish-failed">Parsing or loading the import persona failed! Check the input against the standard specifications, and try again.</span>');
                        }
                       }
                       reader.readAsText(file)

                });

                $('#js-import-persona-json').on('click',function(evt){
                    var personaJSON = $('#import-persona-input').val();
                    try{
                        init_fb(JSON.parse(personaJSON));
                        $('#code').html('<span class="publish-status">A new persona has been imported. You can now proceed with modifying it...</span>');
                    }catch(e){
                        $('#code').html('<span class="publish-failed">Parsing or loading the import persona failed! Check the input against the standard specifications, and try again.</span>');
                    }
                });

                $('#js-import-persona-uri').on('click',function(evt){

                    $.ajax({
                      url: $('#import-persona-uri').val(),
                      type: 'GET',
                      success: function(data){
                            console.log(data)
                            try{
                                init_fb(JSON.parse(data));
                                $('#code').html('<span class="publish-status">A new persona has been imported. You can now proceed with modifying it...</span>');
                            }catch(e){
                                $('#code').html('<span class="publish-failed">Parsing or loading the import persona failed! Check the input against the standard specifications, and try again.</span>');
                            }
                      },
                      error: function(){
                            $('#code').html('<span class="publish-failed">Parsing or loading the import persona failed! Check the input against the standard specifications, and try again.</span>');
                      }
                    });
                });

            }

            /* used in the persona encoding functions... */
            function generateUUID(){
                var d = new Date().getTime();
                if(window.performance && typeof window.performance.now === "function"){
                    d += performance.now(); //use high-precision timer if available
                }
                var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = (d + Math.random()*16)%16 | 0;
                    d = Math.floor(d/16);
                    return (c=='x' ? r : (r&0x3|0x8)).toString(16);
                });
                window.app_uuid = uuid;
                return uuid;
            }

            $(function(){

                init_fb();

            });

        </script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-51296531-6', 'auto');
          ga('send', 'pageview');

        </script>

    </body>
</html>
