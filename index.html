<!doctype html>
<html>
    <head>
        <title>The Survey Designer</title>
        <meta name="description" content="">
        <link rel="stylesheet" href="vendor/css/vendor.css" />
        <link rel="stylesheet" href="vendor/css/spectrum.css" />
        <link rel="stylesheet" href="dist/formbuilder.css" />
    </head>
    <body>
        <header><a href="" style="text-decoration:none"><span class="logo"></span></a> <h1>The Survey Designer | <small>cook & serve new surveys, faster than it takes to make coffee!</small></h1></header>
        <article>
            <div class='fb-main'></div>
        </article>
        <footer>
            <table>
                <tr>
                    <td>
                        <p>  Technology based on
                        <a target="_blank" href="https://nuscribes.com/scribes_app/book/40/read/#Studio">The Studio</a>
                        </p>
                    </td>
                </tr>
            </table>
        </footer>

        <script src="vendor/js/vendor.js"></script>
        <script src="vendor/js/qrcode.js"></script>
        <script src="vendor/js/jquery.qrcode.js"></script>
        <script src="vendor/js/FileSaver.js"></script>
        <script src="vendor/js/Blob.js"></script>
        <script src="vendor/js/spectrum.js"></script>
        <script src="dist/formbuilder.js"></script>

        <script>

            function getUrlVars()
            {
                var vars = [], hash;
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for(var i = 0; i < hashes.length; i++)
                {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                }
                return vars;
            }

            var defaultQRCODE_SIZE = 200;
            var defaultQRCODE_EXPORT_SIZE = 500;
            var defaultEXPORT_SIZE_H = 400;
            var defaultEXPORT_SIZE_W = 1000;

            function make_qrcode(selector,data,size){
                $(selector).empty();
                $(selector).qrcode({
                    render: 'canvas',
                    width: size,
                    height: size,
                    text: data
                });
            }

            function init_fb(persona){

                fb = null;

                if(persona) {
                    fb = new Formbuilder({
                        selector: '.fb-main',
                        bootstrapData: persona.fields
                    });
                    $('#app-name').val(persona.app.name);
                    $('#app-color').spectrum();
                    $('#app-color').spectrum('set',persona.app.color);
                    $('#publish-channel').val(persona.app.channel);
                    $('#app-brand-image').val(persona.app.brand_image);
                    $('#theatre-uri').val(persona.app.theatre_address);
                    $('#transport-mode').val(persona.app.transport_mode);
                    $('#app-description').val(persona.app.description);
                    if(persona.app.uuid)
                        window.app_uuid = persona.app.uuid;
                    else
                        window.app_uuid = undefined;
                }
                else {
                    fb = new Formbuilder({
                        selector: '.fb-main',
                    });
                    $('#app-color').spectrum();
                }

                if($('#theatre-uri').val().trim().length == 0)
                    $('#theatre-uri').val('http://216.104.204.91/surveys/api/act/create/'); //set a default, as our non-tech users of acode might not know what to do here

                if(fb == null)
                    return;

                fb.on('save', function(payload){
                    console.log(payload);

                    if(window.publish_persona){

                      $('#code').html('<span class="publish-status">Wait as this survey is published...</span>');
                        $.ajax({
                          url: 'http://216.104.204.91/surveys/api/persona/create/',
                          type: 'POST',
                          data: payload,
                          contentType: "application/json",
                          success: function(data){
                                data = JSON.parse(data);
                                console.log(data)
                                make_qrcode('#code',data.api, defaultQRCODE_EXPORT_SIZE);
                                $('#code').prepend(
                                            $('<a/>', {'target': '_blank', 'href': data.app, 'class': 'fb-button', 'style': 'margin:10px'}).text('START USING THIS SURVEY!'),
                                            $('<a/>', {'target': '_blank', 'href': data.analytics, 'class': 'fb-button', 'style': 'margin:10px'}).text('ANALYTICS FOR THIS SURVEY!')
                                    );
                          },
                          error: function(){
                              $('#code').html('<span class="publish-failed">Publishing of this survey failed. Ensure that this studio has access to survey publishing facility, such as a theatre. Contact tech[at]nuchwezi[dot]com, for access to a reliable, first-class theatre implementation, or get access to the entire suite of technologies in Project-Okot.</span>');
                          }
                        });

                        window.publish_persona = false;
                    }

                    if(window.download_persona){
                        var appName = JSON.parse(payload).app.name.replace(/\s+/g,"_") || "Persona";
                        var persona_file_name = appName + "-" + (new Date()).toISOString() + ".persona";
                        $('#code').html('<span class="publish-status">Please save the generated survey file: ' + persona_file_name + '</span>');
                        saveAs(new Blob([payload], { type: "application/json+persona" }), persona_file_name)
                        window.download_persona = false;
                    }
                })

                $('#import-persona-file').on('change',function(evt){
                       var files = evt.target.files;
                       var file = files[0];           
                       var reader = new FileReader();
                       reader.onload = function() {
                         console.log(this.result);            
                         try{
                             init_fb(JSON.parse(this.result));
                              $('#code').html('<span class="publish-status">A new survey has been imported. You can now proceed with modifying it...</span>');
                        }catch(e){
                            $('#code').html('<span class="publish-failed">Parsing or loading the import survey failed! Check the input against the standard specifications, and try again.</span>');
                        }
                       }
                       reader.readAsText(file)

                });

                $('#js-import-persona-json').on('click',function(evt){
                    var personaJSON = $('#import-persona-input').val();
                    try{
                        init_fb(JSON.parse(personaJSON));
                        $('#code').html('<span class="publish-status">A new survey has been imported. You can now proceed with modifying it...</span>');
                    }catch(e){
                        $('#code').html('<span class="publish-failed">Parsing or loading the import survey failed! Check the input against the standard specifications, and try again.</span>');
                    }
                });

                $('#js-import-persona-uri').on('click',function(evt){

                    $.ajax({
                      url: $('#import-persona-uri').val(),
                      type: 'GET',
                      success: function(data){
                            console.log(data)
                            try{
                                init_fb(JSON.parse(data));
                                $('#code').html('<span class="publish-status">A new survey has been imported. You can now proceed with modifying it...</span>');
                            }catch(e){
                                $('#code').html('<span class="publish-failed">Parsing or loading the import survey failed! Check the input against the standard specifications, and try again.</span>');
                            }
                      },
                      error: function(){
                            $('#code').html('<span class="publish-failed">Parsing or loading the import survey failed! Check the input against the standard specifications, and try again.</span>');
                      }
                    });
                });

            }

            /* used in the persona encoding functions... */
            function generateUUID(){
                var d = new Date().getTime();
                if(window.performance && typeof window.performance.now === "function"){
                    d += performance.now(); //use high-precision timer if available
                }
                var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = (d + Math.random()*16)%16 | 0;
                    d = Math.floor(d/16);
                    return (c=='x' ? r : (r&0x3|0x8)).toString(16);
                });
                window.app_uuid = uuid;
                return uuid;
            }

            $(function(){


  // first, we check if the studio needs to be bootstrapped some way...
                var query = getUrlVars();
                if(query.purl != undefined){

                    //first, initialize normally...
                    init_fb();
                    $('#code').html('<span class="publish-status">The survey specified in the URL is being loaded. Please wait...</span>');
                    // then go on and fetch the persona to bootstrap with...
                    $.ajax({
                      url: query.purl,
                        async: true,
                        crossDomain: true,
                      type: 'GET',
                      success: function(data){
                            console.log(data)
                            try{
                                init_fb((typeof data === 'string' || data instanceof String) ? JSON.parse(data): data);
                                $('#code').html('<span class="publish-status">The designer has been bootstrapped with the specified survey. You can now proceed with modifying it as you wish...</span>');
                            }catch(e){
                                $('#code').html('<span class="publish-failed">Parsing or loading the survey specified in the URL failed! Check the resource linked to, against the standard survey specifications, and whether it can be accessed by this Survey Designer, and then try again.</span>');
                            }
                      },
                      error: function(){
                            $('#code').html('<span class="publish-failed">Parsing or loading the survey specified in the URL failed! Check the resource linked to, against the standard survey specifications, and whether it can be accessed by this Survey Designer, and then try again.</span>');
                      }
                    });

                }
                else {
                    init_fb();
                }

            });

        </script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-51296531-6', 'auto');
          ga('send', 'pageview');

        </script>

    </body>
</html>
